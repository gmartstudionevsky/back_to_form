# Back to Form (S0)

Минималистичное офлайн‑дружелюбное web‑приложение для фитнеса, питания и прогресса. Интерфейс и документация на русском, ориентировано на мобильные устройства (в первую очередь iPhone/Safari) с крупными элементами, bottom‑навигацией и быстрыми действиями. Приложение работает как PWA и хранит данные локально. 

## Общее описание и принцип работы
Back to Form строится вокруг сценария «План → Сегодня → Факт»: сначала задаются периоды и планы, затем день превращается в «пульт управления», а факт фиксируется через логи питания, активности и здоровья. Состояние хранится в LocalStorage, медиа — в IndexedDB. Система использует единое состояние в Zustand (`useAppStore`), которое загружается из LocalStorage при старте, и сохраняется при каждом обновлении. Миграции данных выполняются автоматически по версии схемы. 

Ключевые блоки приложения:
- **Навигация** — нижние вкладки (Сегодня, Планирование, Питание, Активность, Здоровье, Ещё) переключают основные разделы. Все страницы подключены через `HashRouter`, чтобы не требовать серверной поддержки роутинга. 
- **Данные** — приложение оперирует библиотеками (упражнения, протоколы, продукты, рецепты, напитки, правила, активности, шаблоны задач), планами (периоды и дневные планы) и логами (факт по питанию, тренировкам, движению, сну, весу, талии, сигаретам, фото и т. д.).
- **Аналитика** — расчёт калорий и макросов, коэффициенты активности, оценка прогресса и графики. 

## Навигация и страницы

### 1. Сегодня (`/`)
Главный экран‑пульт, агрегирует план и фактические действия выбранной даты: 
- Быстрые формы для фиксации питания, тренировок, движения, курения, напитков, сна, веса и талии. 
- Быстрый запуск протоколов тренировок через встроенный **Workout Runner** (таймер шагов, подсказки по упражнениям, видео/YouTube). 
- Поддержка плановых требований дня (например, обязательные фото или показатели). 
- Быстрая отметка выполнения запланированных элементов (питание, тренировки, задачи). 

### 2. Планирование (`/plan`)
Центр формирования периодов и дневных планов:
- Создание периодов с датами, целями и заметками. 
- Дневные планы питания по приёмам пищи (завтрак/обед/ужин/перекус) с граммовками, порциями, тегами, временем и заметками. 
- Планирование тренировок и активности: протоколы, движение, целевые минуты, обязательность. 
- Требования на день: вес, талия, фото, лимит сигарет, цели сна. 
- Задачи дня по шаблонам (warmup, movement, strength, nutrition, smoking, sleep, measurement). 
- Копирование меню между датами и установка дефолтов периода (время еды, нутри‑цели, требования, активности). 

### 3. Питание (`/nutrition`)
Отдельный журнал питания и напитков:
- Ручные записи с макросами и временем (факт). 
- Сопоставление с планом питания (процент закрытия). 
- Итоги по калориям и Б/Ж/У с учётом напитков. 
- 7‑дневные показатели: средняя калорийность, пиковый день, покрытие. 

### 4. Активность (`/activity`)
Логи тренировок, движения и шагов:
- Фактические тренировки и движения (длительность, дистанция, шаги). 
- Отдельная запись шагов дня. 
- Подсчёт коэффициента активности и калорий по тренировкам/движению на базе заданных метрик. 
- Недельные инсайты (средние минуты, пиковые шаги, покрытие). 

### 5. Здоровье (`/health`)
Контроль привычек и показателей тела:
- Логи курения (кол-во, триггер). 
- Сон: время сна, подъёма, качество, анкоры. 
- Вес и талия с автоподбором последних значений. 
- Гидратация с учётом напитков и продуктов, поддерживающих воду. 
- Недельные инсайты сна (средняя длительность, соблюдение anchor‑режима). 

### 6. Ещё (`/more`)
Вторичные разделы:
- **Библиотеки** (`/library`) 
- **Прогресс** (`/progress`) 
- **Фото** (`/photos`) 
- **Настройки** (`/settings`) 

### 7. Трекер факта (`/track`)
Чтение фактов по всем разделам дня:
- Разбивка на вкладки «Питание», «Активность», «Здоровье». 
- Сравнение план/факт, статусы выполнения и статистика за день. 
- Read‑only экран: редактирование и ввод делаются в основных разделах. 

### 8. Прогресс (`/progress`)
Графики по ключевым метрикам:
- Калории, вес, талия, тренировки, шаги/сигареты. 
- Диапазоны 7/14/30/365 дней. 

### 9. Фото (`/photos`)
Локальная галерея прогресса:
- Фото «фронт/профиль/другое», привязанные к дате. 
- Хранение самих файлов в IndexedDB (не попадают в JSON‑экспорт). 
- Быстрые загрузки фото на основе требований из плана дня. 

### 10. Настройки (`/settings`)
Операции с данными:
- Экспорт JSON (все сущности кроме медиа). 
- Импорт JSON (полная замена данных). 
- CSV summary по дням (калории, макросы, тренировки, шаги, сигареты, вес, талия, выполнение плана). 
- Полный сброс данных к seed‑состоянию. 

## Библиотеки и вложенные элементы
В приложении предусмотрены отдельные библиотеки и вложенные элементы, которые «подкладываются» в планы и логи.

### Библиотека контента (`/library`)
- **Продукты**: калории, Б/Ж/У, порции, вес «шт.», гидратация. 
- **Блюда/рецепты**: ингредиенты, категории, порции, питание по порции. 
- **Напитки**: калории/макросы и коэффициент гидратации. 
- **Упражнения**: шаги выполнения, подсказки, ошибки, регрессии/прогрессии, медиа (YouTube/локальное видео). 
- **Протоколы**: последовательность шагов тренировки с таймерами. 
- **Движение**: типы активности (ходьба, бег, лестницы) и формулы расчёта. 
- **Правила** и **шаблоны задач**: подключаются в дневные планы. 

### Вложенные элементы в планировании
- **План питания** → пункт состоит из продукта/блюда/свободного текста/читмила. 
- **Компоненты блюда** → «основное», «гарнир», «салат», «суп», «напиток», «десерт», «перекус». 
- **Задачи дня** → создаются из шаблонов и имеют статус (planned/done/skipped), цель и фактическое значение. 
- **Тренировки дня** → связываются с протоколом или движением, задаётся время суток, длительность и обязательность. 

## Компоненты интерфейса
- **BottomTabs** — нижняя навигация по основным разделам. 
- **BottomSheet** — модальные формы для ввода/редактирования (фиксирует фокус, блокирует скролл). 
- **WorkoutRunner** — пошаговый прогресс тренировки с таймером, упражнениями и медиа. 
- **Accordion** — компактные раскрывающиеся блоки для деталей. 

## Данные и модель сущностей

### AppData
Состояние состоит из трёх больших частей:
- **library**: упражнения, протоколы, продукты, рецепты, напитки, правила, активности движения, шаблоны задач, настройки метрик активности. 
- **planner**: периоды и дневные планы (меню, тренировки, требования, цели). 
- **logs**: фактические логи питания, активности, курения, воды/напитков, веса, талии, сна, фото. 

### Ключевые сущности
- **Exercise / Protocol** — основа тренировочного блока (упражнения с медиа → протоколы). 
- **Product / Recipe / Drink** — питание и напитки с нутриентами. 
- **Period / DayPlan** — план на даты с целями, меню, тренировками и требованиями. 
- **TaskTemplate / TaskInstance** — шаблоны задач (warmup, movement, strength и др.), которые подставляются в день. 
- **Logs** — фактические записи (еда, тренировки, движение, курение, сон, вес, талия и т. д.). 

## Расчёты и аналитика
- **Питание**: калории и Б/Ж/У считаются от продукта/блюда, либо берутся из ручных override‑полей. 
- **Рецепты**: нутриенты агрегируются по ингредиентам и распределяются по порциям. 
- **Активность**: коэффициент активности рассчитывается по модели (время/дистанция/шаги/лестницы/комбинированно), на основе дефолтов и метрик конкретного упражнения/активности. 
- **Калории активности**: корректируются по контексту (вес, intake, коэффициент активности и др.). 

## Хранение и офлайн
- **LocalStorage** (`btf-data`) — все структурированные данные. Запись выполняется безопасно (silent‑fail в приватных режимах). 
- **IndexedDB** — хранение фото и локальных видео упражнений. 
- **Service Worker** — кэширует базовые ассеты и обеспечивает офлайн‑доступ. Навигация — network‑first, остальные ресурсы — cache‑first с фоновым обновлением. 

## Миграции данных
- Версия схемы (`schemaVersion`) хранится в seed‑данных. 
- При несовпадении версий запускаются миграции, которые дополняют старые данные новыми полями, сохраняя историю пользователя. 

## Debug‑режим
Логи состояния включаются автоматически в dev‑режиме или вручную через LocalStorage:
```js
localStorage.setItem('btf-debug', '1')
```

## Стек
- **TypeScript + React + Vite**
- **TailwindCSS**
- **Zustand**
- **LocalStorage + IndexedDB**
- **PWA** (manifest + service worker)

## Запуск локально
```bash
npm install
npm run dev
```

## Сборка
```bash
npm run build
npm run preview
```

## Деплой на GitHub Pages
В репозитории есть workflow `.github/workflows/deploy.yml`, который собирает Vite‑приложение и публикует содержимое `dist`.

1. Проверьте, что в `vite.config.ts` корректный `base` (по умолчанию `'/back_to_form/'`).
2. Пуш в `main` автоматически запускает build + deploy через GitHub Actions.

> Если репозиторий называется иначе, задайте `VITE_BASE_PATH` при сборке:
```bash
VITE_BASE_PATH=/my-repo/ npm run build
```

## Где править стартовые данные
Все глобальные сущности хранятся в `src/data/seed.ts`. После первого запуска данные сохраняются в LocalStorage. Чтобы «пересидить» seed, используйте кнопку **Сбросить все данные** в настройках.

## Ограничения
- Нет синхронизации между устройствами и серверной авторизации. 
- Экспорт/импорт — ручной, JSON‑экспорт не содержит медиафайлы. 

## Примечания по дизайну
- Шрифт: Manrope (максимально близко к Circe).
- Переходы, bottom sheet и карточки сделаны минималистично для мобильного сценария.
